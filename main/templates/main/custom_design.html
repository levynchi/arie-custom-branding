{% extends 'main/base.html' %}
{% load static %}

{% block title %}注爪 砖 - 专 拽住 转{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'main/css/custom_design.css' %}?v=20250722080000">
{% endblock %}

{% block content %}

<!-- Modern Design Interface -->
<div class="design-interface" data-save-url="{% url 'main:save_design' %}">
    <!-- Top Header -->
    <div class="design-header">
        <div class="header-left">
            <h4 class="mb-0">
                <i class="fas fa-palette me-2"></i>
                注爪 砖
            </h4>
        </div>
        <div class="header-center">
            <!-- Product Selection -->
            <div class="dropdown">
                <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="productDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-box-open me-1"></i>
                    <span id="selectedProductText">专 爪专...</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="productDropdown">
                    {% for product in products %}
                    <li>
                        <a class="dropdown-item product-dropdown-item{% if selected_product and selected_product.id == product.id %} active{% endif %}" 
                           href="#" 
                           data-product-id="{{ product.id }}" 
                           data-product-name="{{ product.name }}"
                           data-product-price="{{ product.price }}"
                           data-product-image="{% if product.image %}{{ product.image.url }}{% endif %}"
                           {% if product.can_print and product.max_print_width and product.max_print_height %}
                           data-product-print-size="{{ product.max_print_width }}x{{ product.max_print_height }} 住\""
                           {% endif %}
                           onclick="event.preventDefault(); selectProductFromDropdown(this, event);">
                            <div class="d-flex align-items-center">
                                {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                         class="product-thumbnail">
                                {% else %}
                                    <i class="fas fa-tshirt me-2"></i>
                                {% endif %}
                                <div>
                                    <div class="fw-bold">{{ product.name }}</div>
                                    <small class="text-muted">{{ product.price }}</small>
                                </div>
                            </div>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-outline-success btn-sm me-2" onclick="saveDesign()">
                <i class="fas fa-save me-1"></i>砖专
            </button>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="design-workspace">
        <!-- Left Side - Canvas Area -->
        <div class="canvas-area">
            <!-- Tool Options Bar (appears above canvas when tool is selected) -->
            <div class="tool-options-bar hidden" id="toolOptionsBar">
                <div class="tool-options-content">
                    <!-- AI Options -->
                    <div class="tool-options active" id="ai-options">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small">转专 注爪</label>
                                <textarea id="promptInput" class="form-control form-control-sm" rows="2" 
                                          placeholder="转专 转 注爪 专爪..."></textarea>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">转转 住 (驻爪)</label>
                                <input type="file" class="form-control form-control-sm" id="styleImageInput" 
                                       accept="image/*" onchange="handleStyleImageUpload(this)">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">&nbsp;</label>
                                <button class="btn btn-primary btn-sm w-100" onclick="generateAIDesign()" id="generateBtn">
                                    <i class="fas fa-magic me-1"></i>爪专
                                </button>
                            </div>
                        </div>
                        <div id="aiStatus" class="mt-2 text-center hidden">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <span>爪专 注爪...</span>
                        </div>
                    </div>

                    <!-- Images Options -->
                    <div class="tool-options" id="images-options">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <input type="text" id="freepikSearchInput" class="form-control form-control-sm" 
                                       placeholder="驻砖 转转..."
                                       onkeypress="handleFreepikSearchKeypress(event)">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-sm w-100" onclick="searchFreepikImages()" id="freepikSearchBtn">
                                    <i class="fas fa-search me-1"></i>驻砖
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="transparentOnlyFilter" onchange="toggleTransparentFilter()">
                                    <label class="form-check-label small" for="transparentOnlyFilter">专拽注 砖拽祝</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="vectorOnlyFilter" onchange="toggleVectorFilter()">
                                    <label class="form-check-label small" for="vectorOnlyFilter">拽专</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group btn-group-sm w-100">
                                    <button type="button" class="btn btn-outline-secondary" onclick="quickSearch('logo transparent')"></button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="quickSearch('icon vector')">拽</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="quickSearch('animal cutout')">转</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Results Area - moved here from outside -->
                        <div id="searchResultsArea" class="hidden mt-3">
                            <div id="freepikSearchStatus" class="text-center small hidden">
                                <div class="spinner-border spinner-border-sm me-1"></div>
                                <span>驻砖...</span>
                            </div>
                            
                            <div id="imageSourceIndicator" class="text-center mb-2 hidden">
                                <small class="badge bg-info"></small>
                            </div>
                            
                            <div id="freepikResults" class="hidden">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Text Options -->
                    <div class="tool-options" id="text-options">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <input type="text" id="textInput" class="form-control form-control-sm" 
                                       placeholder="拽 拽住...">
                            </div>
                            <div class="col-md-2">
                                <select id="fontFamily" class="form-select form-select-sm">
                                    <option value="Arial">Arial</option>
                                    <option value="Heebo">Heebo</option>
                                    <option value="Assistant">Assistant</option>
                                    <option value="David">David</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="range" id="fontSize" class="form-range" min="10" max="100" value="24">
                                <small class="text-muted">: <span id="fontSizeValue">24</span></small>
                            </div>
                            <div class="col-md-2">
                                <div class="current-color-indicator">
                                    <div id="currentColorSwatch" class="current-color-swatch"></div>
                                    <span id="currentColorText">砖专</span>
                                </div>
                                <input type="color" id="textColor" class="form-control form-control-color" value="#000000">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-sm w-100" onclick="addText()">
                                    <i class="fas fa-plus me-1"></i>住祝
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload Options -->
                    <div class="tool-options" id="upload-options">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-8">
                                <input type="file" id="imageInput" accept="image/*" class="form-control form-control-sm" onchange="addImage(event)">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success btn-sm w-100" onclick="document.getElementById('imageInput').click()">
                                    <i class="fas fa-upload me-1"></i>专 转
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Emoji Options -->
                    <div class="tool-options" id="emoji-options">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-8">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="toggleEmojiPicker()">
                                    <i class="fas fa-smile me-1"></i>专 '
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning btn-sm w-100" onclick="addEmoji('')">
                                    <span style="font-size: 1.2em;"></span> 专
                                </button>
                            </div>
                        </div>
                        <div id="emojiPicker" class="emoji-picker mt-2 hidden">
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('ぃ')">ぃ</span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('わ')">わ</span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                            <span class="emoji-item" onclick="addEmoji('')"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Product Warning -->
            <div id="noProductMessage" class="alert alert-warning text-center{% if selected_product %} d-none{% endif %}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>砖 专 爪专 转</strong><br>
                专 爪专 专砖  转 注爪
            </div>

            <!-- Canvas Container -->
            <div class="canvas-container">
                <div id="designCanvas" class="design-canvas{% if selected_product %} with-product{% endif %}"
                     {% if selected_product and selected_product.image %}
                     style="background-image: url('{{ selected_product.image.url }}');"
                     {% endif %}>
                    
                    <div id="placeholderText" class="canvas-placeholder{% if selected_product %} hide-when-product{% endif %}">
                        <i class="fas fa-mouse-pointer canvas-placeholder"></i>
                        <p>专  爪  转 注爪</p>
                    </div>
                    
                    <!-- Print Dimensions Display -->
                    <div id="printDimensions" class="print-dimensions{% if selected_product %} d-block{% else %} d-none{% endif %}">
                        <small>
                            <i class="fas fa-ruler me-1"></i>
                            <span id="printDimensionsText">
                                {% if selected_product %}{{ selected_product.max_print_width }}x{{ selected_product.max_print_height }} 住"{% endif %}
                            </span>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Canvas Controls -->
            <div class="canvas-controls">
                <button class="btn btn-outline-secondary btn-sm" onclick="zoomOut()">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="zoom-level">100%</span>
                <button class="btn btn-outline-secondary btn-sm" onclick="zoomIn()">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm ms-3" onclick="clearCanvas()">
                    <i class="fas fa-trash"></i>拽 
                </button>
            </div>
        </div>

        <!-- Right Side - Tool Buttons -->
        <div class="tools-sidebar">
            <!-- Product Selection Required Message -->
            <div id="toolsDisabledMessage" class="alert alert-info text-center mb-3{% if selected_product %} d-none{% endif %}">
                <i class="fas fa-info-circle me-2"></i>
                <strong>专 爪专 转</strong><br>
                <small>砖 专 爪专 转驻专 注  驻注 转  注爪</small>
            </div>
            
            <div class="tools-list" id="toolsList">
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="ai" 
                        onclick="selectTool(this, 'ai')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-robot"></i>
                    <span>爪专转 注爪 AI</span>
                </button>
                
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="images" 
                        onclick="selectTool(this, 'images')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-images"></i>
                    <span>驻砖 转转 驻专驻拽</span>
                </button>
                
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="text" 
                        onclick="selectTool(this, 'text')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-font"></i>
                    <span>住祝 拽住</span>
                </button>
                
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="upload" 
                        onclick="selectTool(this, 'upload')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-upload"></i>
                    <span>住驻转 转</span>
                </button>

                <div class="tools-divider"></div>

                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="shapes" 
                        onclick="selectTool(this, 'shapes')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-shapes"></i>
                    <span>爪专转</span>
                </button>
                
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="qr" 
                        onclick="selectTool(this, 'qr')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-qrcode"></i>
                    <span>QR Code</span>
                </button>

                <div class="tools-divider"></div>

                <button class="tool-button danger{% if not selected_product %} disabled{% endif %}" 
                        onclick="clearCanvas()"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-trash"></i>
                    <span>拽 </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Save Modal -->
<div class="modal fade" id="saveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">砖专转 注爪</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="designName" class="form-label">砖 注爪</label>
                    <input type="text" class="form-control" id="designName" placeholder="住 砖 注爪">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"></button>
                <button type="button" class="btn btn-primary" onclick="confirmSave()">砖专</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'main/js/custom_design.js' %}?v=20250722081200"></script>
{% endblock %}
