{% extends 'main/base.html' %}
{% load static %}

{% block title %}עיצוב אישי - אריה קאסטום מיתוגים{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'main/css/custom_design.css' %}?v=20250727170000">
{% endblock %}

{% block content %}

<!-- Modern Design Interface -->
<div class="design-interface" data-save-url="{% url 'main:save_design' %}">
    <!-- Top Header -->
    <div class="design-header">
        <div class="header-left">
            <h4 class="mb-0">
                <i class="fas fa-palette me-2"></i>
              <script src="{% static 'main/js/custom_design.js' %}?v=20250727183500"></script>     עיצוב אישי
            </h4>
        </div>
        <div class="header-center">
            <!-- Product Selection -->
            <div class="dropdown">
                <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="productDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-box-open me-1"></i>
                    <span id="selectedProductText">בחר מוצר...</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="productDropdown">
                    {% for product in products %}
                    <li>
                        <a class="dropdown-item product-dropdown-item{% if selected_product and selected_product.id == product.id %} active{% endif %}" 
                           href="#" 
                           data-product-id="{{ product.id }}" 
                           data-product-name="{{ product.name }}"
                           data-product-price="{{ product.price }}"
                           data-product-image="{% if product.image %}{{ product.image.url }}{% endif %}"
                           {% if product.can_print and product.max_print_width and product.max_print_height %}
                           data-product-print-size="{{ product.max_print_width }}x{{ product.max_print_height }} ס\"מ"
                           {% endif %}
                           onclick="event.preventDefault(); selectProductFromDropdown(this, event);">
                            <div class="d-flex align-items-center">
                                {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                         class="product-thumbnail">
                                {% else %}
                                    <i class="fas fa-tshirt me-2"></i>
                                {% endif %}
                                <div>
                                    <div class="fw-bold">{{ product.name }}</div>
                                    <small class="text-muted">₪{{ product.price }}</small>
                                </div>
                            </div>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-outline-success btn-sm me-2" onclick="saveDesign()">
                <i class="fas fa-save me-1"></i>שמור
            </button>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="design-workspace">
        <!-- Left Side - Canvas Area -->
        <div class="canvas-area">
            <!-- Tool Options Bar (appears above canvas when tool is selected) -->
            <div class="tool-options-bar hidden" id="toolOptionsBar">
                <div class="tool-options-content">
                    <!-- AI Options -->
                    <div class="tool-options active" id="ai-options">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small">תיאור העיצוב</label>
                                <textarea id="promptInput" class="form-control form-control-sm" rows="2" 
                                          placeholder="תאר את העיצוב הרצוי..."></textarea>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">תמונת סטייל (אופציונלי)</label>
                                <input type="file" class="form-control form-control-sm" id="styleImageInput" 
                                       accept="image/*" onchange="handleStyleImageUpload(this)">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">&nbsp;</label>
                                <button class="btn btn-primary btn-sm w-100" onclick="generateAIDesign()" id="generateBtn">
                                    <i class="fas fa-magic me-1"></i>צור
                                </button>
                            </div>
                        </div>
                        <div id="aiStatus" class="mt-2 text-center hidden">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <span>יוצר עיצוב...</span>
                        </div>
                    </div>

                    <!-- Images Options -->
                    <div class="tool-options" id="images-options">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <input type="text" id="freepikSearchInput" class="form-control form-control-sm" 
                                       placeholder="חפש תמונות..."
                                       onkeypress="handleFreepikSearchKeypress(event)">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-sm w-100" onclick="searchFreepikImages()" id="freepikSearchBtn">
                                    <i class="fas fa-search me-1"></i>חפש
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="transparentOnlyFilter" onchange="toggleTransparentFilter()">
                                    <label class="form-check-label small" for="transparentOnlyFilter">רקע שקוף</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="vectorOnlyFilter" onchange="toggleVectorFilter()">
                                    <label class="form-check-label small" for="vectorOnlyFilter">וקטור</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group btn-group-sm w-100">
                                    <button type="button" class="btn btn-outline-secondary" onclick="quickSearch('logo transparent')">לוגו</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="quickSearch('icon vector')">איקון</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="quickSearch('animal cutout')">חיות</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Results Area - moved here from outside -->
                        <div id="searchResultsArea" class="hidden mt-3">
                            <div id="freepikSearchStatus" class="text-center small hidden">
                                <div class="spinner-border spinner-border-sm me-1"></div>
                                <span>מחפש...</span>
                            </div>
                            
                            <div id="imageSourceIndicator" class="text-center mb-2 hidden">
                                <small class="badge bg-info"></small>
                            </div>
                            
                            <div id="freepikResults" class="hidden">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Text Options -->
                    <div class="tool-options" id="text-options">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <input type="text" id="textInput" class="form-control form-control-sm" 
                                       placeholder="הקלד טקסט...">
                            </div>
                            <div class="col-md-2">
                                <select id="fontFamily" class="form-select form-select-sm font-preview-select">
                                    <option value="Arial" style="font-family: Arial;">Arial</option>
                                    <option value="Inter" style="font-family: Inter;">Inter - אינטר</option>
                                    <option value="Poppins" style="font-family: Poppins;">Poppins - פופינס</option>
                                    <option value="Heebo" style="font-family: Heebo;">Heebo - הבו</option>
                                    <option value="Rubik" style="font-family: Rubik;">Rubik - רוביק</option>
                                    <option value="Noto Sans Hebrew" style="font-family: 'Noto Sans Hebrew';">Noto Sans Hebrew - נוטו</option>
                                    <option value="Frank Ruhl Libre" style="font-family: 'Frank Ruhl Libre';">Frank Ruhl Libre - פרנק</option>
                                    <option value="Assistant" style="font-family: Assistant;">Assistant - אסיסטנט</option>
                                    <option value="Open Sans" style="font-family: 'Open Sans';">Open Sans - אופן</option>
                                    <option value="Varela Round" style="font-family: 'Varela Round';">Varela Round - ורלה</option>
                                    <option value="Alef" style="font-family: Alef;">Alef - אל״ף</option>
                                    <option value="Secular One" style="font-family: 'Secular One';">Secular One - חילוני</option>
                                    <option value="Suez One" style="font-family: 'Suez One';">Suez One - סואץ</option>
                                    <option value="Amatic SC" style="font-family: 'Amatic SC';">Amatic SC - אמטיק</option>
                                    <option value="Miriam Libre" style="font-family: 'Miriam Libre';">Miriam Libre - מרים</option>
                                    <option value="Tinos" style="font-family: Tinos;">Tinos - טינוס</option>
                                    <option value="David CLM" style="font-family: 'David CLM';">David CLM - דוד</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <input type="range" id="fontSize" class="form-range" min="10" max="100" value="24">
                                <small class="text-muted">גודל: <span id="fontSizeValue">24</span></small>
                            </div>
                            <div class="col-md-1">
                                <div class="current-color-indicator">
                                    <div id="currentColorSwatch" class="current-color-swatch"></div>
                                    <span id="currentColorText">שחור</span>
                                </div>
                                <input type="color" id="textColor" class="form-control form-control-color" value="#000000">
                            </div>
                            <div class="col-md-2">
                                <div class="btn-group btn-group-sm w-100">
                                    <button type="button" class="btn btn-outline-secondary" id="boldBtn" onclick="toggleBold()" title="הדגשה מהירה">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="archBtn" onclick="toggleArch()" title="קשת">
                                        <i class="fas fa-rainbow"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-1">
                                <input type="range" id="archCurve" class="form-range" min="-50" max="50" value="0" style="display: none;" oninput="updateArchCurve(this.value)">
                                <small class="text-muted arch-controls" style="display: none;">קשת: <span id="archCurveValue">0</span></small>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-primary btn-sm w-100" onclick="addText()">
                                    <i class="fas fa-plus me-1"></i>הוסף
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload Options -->
                    <div class="tool-options" id="upload-options">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-8">
                                <input type="file" id="imageInput" accept="image/*" class="form-control form-control-sm" onchange="addImage(event)">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success btn-sm w-100" onclick="document.getElementById('imageInput').click()">
                                    <i class="fas fa-upload me-1"></i>בחר תמונה
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Emoji Options -->
                    <div class="tool-options" id="emoji-options">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-8">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="toggleEmojiPicker()">
                                    <i class="fas fa-smile me-1"></i>בחר אימוג'י
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning btn-sm w-100" onclick="addEmoji('😀')">
                                    <span style="font-size: 1.2em;">😀</span> מהיר
                                </button>
                            </div>
                        </div>
                        <div id="emojiPicker" class="emoji-picker mt-2 hidden">
                            <span class="emoji-item" onclick="addEmoji('😀')">😀</span>
                            <span class="emoji-item" onclick="addEmoji('😃')">😃</span>
                            <span class="emoji-item" onclick="addEmoji('😄')">😄</span>
                            <span class="emoji-item" onclick="addEmoji('😁')">😁</span>
                            <span class="emoji-item" onclick="addEmoji('😆')">😆</span>
                            <span class="emoji-item" onclick="addEmoji('😅')">😅</span>
                            <span class="emoji-item" onclick="addEmoji('🤣')">🤣</span>
                            <span class="emoji-item" onclick="addEmoji('😂')">😂</span>
                            <span class="emoji-item" onclick="addEmoji('❤️')">❤️</span>
                            <span class="emoji-item" onclick="addEmoji('👍')">👍</span>
                            <span class="emoji-item" onclick="addEmoji('👎')">👎</span>
                            <span class="emoji-item" onclick="addEmoji('🔥')">🔥</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Product Warning -->
            <div id="noProductMessage" class="alert alert-warning text-center{% if selected_product %} d-none{% endif %}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>יש לבחור מוצר תחילה</strong><br>
                בחר מוצר מהרשימה כדי להתחיל לעצב
            </div>

            <!-- Canvas Container -->
            <div class="canvas-container">
                <div id="designCanvas" class="design-canvas{% if selected_product %} with-product{% endif %}"
                     {% if selected_product and selected_product.image %}
                     style="background-image: url('{{ selected_product.image.url }}');"
                     {% endif %}>
                    
                    <div id="placeholderText" class="canvas-placeholder{% if selected_product %} hide-when-product{% endif %}">
                        <i class="fas fa-mouse-pointer canvas-placeholder"></i>
                        <p>בחר כלי מהצד הימני להתחיל לעצב</p>
                    </div>
                    
                    <!-- Print Dimensions Display -->
                    <div id="printDimensions" class="print-dimensions{% if selected_product %} d-block{% else %} d-none{% endif %}">
                        <small>
                            <i class="fas fa-ruler me-1"></i>
                            <span id="printDimensionsText">
                                {% if selected_product %}{{ selected_product.max_print_width }}x{{ selected_product.max_print_height }} ס"מ{% endif %}
                            </span>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Canvas Controls -->
            <div class="canvas-controls">
                <button class="btn btn-outline-secondary btn-sm" onclick="zoomOut()">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="zoom-level">100%</span>
                <button class="btn btn-outline-secondary btn-sm" onclick="zoomIn()">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm ms-3" onclick="clearCanvas()">
                    <i class="fas fa-trash"></i>נקה הכל
                </button>
            </div>
        </div>

        <!-- Left Side - Layers Panel -->
        <div class="layers-sidebar">
            <div class="layers-panel" id="layersPanel">
                <div class="layers-header">
                    <h6 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>
                        שכבות
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleLayersPanel()" title="הסתר/הצג פאנל שכבות">
                        <i class="fas fa-eye" id="layersPanelToggleIcon"></i>
                    </button>
                </div>
                <div class="layers-content" id="layersContent">
                    <div class="layers-list" id="layersList">
                        <div class="no-layers-message text-center text-muted">
                            <i class="fas fa-info-circle mb-2"></i>
                            <small>אין שכבות עדיין<br>הוסף אלמנטים לקנבס</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side - Tool Buttons -->
        <div class="tools-sidebar">
            <!-- Product Selection Required Message -->
            <div id="toolsDisabledMessage" class="alert alert-info text-center mb-3{% if selected_product %} d-none{% endif %}">
                <i class="fas fa-info-circle me-2"></i>
                <strong>בחר מוצר תחילה</strong><br>
                <small>יש לבחור מוצר מהתפריט למעלה כדי להפעיל את כלי העיצוב</small>
            </div>
            
            <div class="tools-list" id="toolsList">
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="ai" 
                        onclick="selectTool(this, 'ai')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-robot"></i>
                    <span>יצירת עיצוב AI</span>
                </button>
                
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="images" 
                        onclick="selectTool(this, 'images')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-images"></i>
                    <span>חיפוש תמונות מפרייפיק</span>
                </button>
                
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="text" 
                        onclick="selectTool(this, 'text')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-font"></i>
                    <span>הוסף טקסט</span>
                </button>
                
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="upload" 
                        onclick="selectTool(this, 'upload')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-upload"></i>
                    <span>הוספת תמונה</span>
                </button>

                <div class="tools-divider"></div>

                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="shapes" 
                        onclick="selectTool(this, 'shapes')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-shapes"></i>
                    <span>צורות</span>
                </button>
                
                <button class="tool-button{% if not selected_product %} disabled{% endif %}" 
                        data-tool="qr" 
                        onclick="selectTool(this, 'qr')"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-qrcode"></i>
                    <span>QR Code</span>
                </button>

                <div class="tools-divider"></div>

                <button class="tool-button danger{% if not selected_product %} disabled{% endif %}" 
                        onclick="clearCanvas()"
                        {% if not selected_product %}disabled{% endif %}>
                    <i class="fas fa-trash"></i>
                    <span>נקה הכל</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Save Modal -->
<div class="modal fade" id="saveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">שמירת עיצוב</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="designName" class="form-label">שם העיצוב</label>
                    <input type="text" class="form-control" id="designName" placeholder="הכנס שם לעיצוב">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                <button type="button" class="btn btn-primary" onclick="confirmSave()">שמור</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- CSS Debug Analyzer Tool -->
<script src="{% static 'main/js/css_debug_analyzer.js' %}?v=20250726"></script>

<!-- Professional Arc Text Implementation Based on Demo -->
<script>
// Professional Arc Text Controller (based on your demo)
class SimpleArcText {
    constructor() {
        this.currentArc = 0;
        this.element = null;
        this.originalText = '';
    }

    init(element) {
        this.element = element;
        this.originalText = element.textContent;
        console.log('SimpleArcText initialized with:', this.originalText);
    }

    setArc(value) {
        this.currentArc = parseInt(value);
        console.log('Setting arc to:', this.currentArc);
        this.updateDisplay();
    }

    updateDisplay() {
        if (!this.element) return;

        if (this.currentArc === 0) {
            // No arc - show normal text
            this.element.innerHTML = this.originalText;
            this.element.style.width = 'auto';
            this.element.style.height = 'auto';
            this.element.style.position = 'relative';
            this.element.style.display = 'inline-block';
            return;
        }

        const fontSize = parseInt(window.getComputedStyle(this.element).fontSize) || 32;
        const fontFamily = window.getComputedStyle(this.element).fontFamily || 'Arial';
        const color = window.getComputedStyle(this.element).color || '#333333';
        const letterSpacing = parseFloat(window.getComputedStyle(this.element).letterSpacing) || 0;
        
        // Dynamic container sizing based on text properties
        const textLength = this.originalText.length;
        const estimatedCharWidth = fontSize * 0.6; // Approximate character width
        const totalLetterSpacing = letterSpacing * (textLength - 1);
        const estimatedTextWidth = (textLength * estimatedCharWidth) + totalLetterSpacing;
        
        // Calculate dynamic container dimensions
        const minWidth = 200;
        const minHeight = 80;
        const containerWidth = Math.max(minWidth, estimatedTextWidth + 50);
        const containerHeight = Math.max(minHeight, fontSize * 3);
        
        const centerX = containerWidth / 2;
        const centerY = containerHeight / 2;
        
        // Calculate arc path with better proportions
        const pathWidth = Math.min(estimatedTextWidth, containerWidth - 40);
        const startX = centerX - pathWidth / 2;
        const endX = centerX + pathWidth / 2;
        
        // Arc intensity - adjusted for container size
        const arcIntensity = Math.abs(this.currentArc) * 0.8;
        
        let pathD;
        if (this.currentArc > 0) {
            // Positive arc (smile - down)
            const curveY = centerY + arcIntensity;
            pathD = `M ${startX} ${centerY} Q ${centerX} ${curveY} ${endX} ${centerY}`;
        } else {
            // Negative arc (frown - up)
            const curveY = centerY - arcIntensity;
            pathD = `M ${startX} ${centerY} Q ${centerX} ${curveY} ${endX} ${centerY}`;
        }

        const pathId = `arcPath_${Date.now()}`;
        
        // Create SVG with dynamic dimensions and letter spacing
        const svg = `
            <svg width="${containerWidth}" height="${containerHeight}" 
                 viewBox="0 0 ${containerWidth} ${containerHeight}" 
                 style="display: block; margin: 0 auto; max-width: 100%; overflow: visible;">
                <defs>
                    <path id="${pathId}" d="${pathD}" />
                </defs>
                <text font-family="${fontFamily}" font-size="${fontSize}px" fill="${color}" 
                      letter-spacing="${letterSpacing}px"
                      text-anchor="middle" dominant-baseline="central">
                    <textPath href="#${pathId}" startOffset="50%">
                        ${this.originalText}
                    </textPath>
                </text>
            </svg>
        `;
        
        console.log(`Dynamic SVG: ${containerWidth}x${containerHeight}, fontSize: ${fontSize}px, letterSpacing: ${letterSpacing}px`);
        
        this.element.innerHTML = svg;
        this.element.style.width = `${containerWidth}px`;
        this.element.style.height = `${containerHeight}px`;
        this.element.style.margin = '0 auto';
        this.element.style.maxWidth = '100%';
        this.element.style.position = 'relative';
        this.element.style.display = 'inline-block';
        this.element.style.overflow = 'visible';
    }

    setText(text) {
        this.originalText = text;
        console.log('Text updated to:', text);
        this.updateDisplay();
    }

    reset() {
        this.currentArc = 0;
        this.updateDisplay();
    }
}

// Global arc text controller instance (like in your demo)
window.globalArcText = new SimpleArcText();

// Updated Hebrew arch text function using the professional approach
function createHebrewArchText(element, radius, direction) {
    const text = element.textContent;
    
    console.log(`[createHebrewArchText] Called with radius: ${radius}, direction: ${direction}, text: "${text}"`);
    
    if (radius === 0) {
        window.globalArcText.reset();
        return;
    }
    
    // Convert radius to arc value (like their conversion system)
    const arcValue = radius * direction; // Positive for down, negative for up
    
    // Initialize if not already done
    if (!window.globalArcText.element || window.globalArcText.element !== element) {
        window.globalArcText.init(element);
    }
    
    // Set the arc
    window.globalArcText.setArc(arcValue);
    
    console.log(`✅ Professional arc text created with arc: ${arcValue}`);
}

// Make it globally available
window.createCurvedText = createHebrewArchText;

console.log('✅ Professional Arc Text System loaded successfully');
</script>
<script src="{% static 'main/js/custom_design.js' %}?v=20250727180000"></script>
{% endblock %}
